{"version":3,"file":"score.min.js","sources":["../src/score.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @author    Guillermo Leon Alvarez Salamanca\n * @copyright Copyright (c) 2017 Open LMS (https://www.openlms.net)\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * JS code to listen the disclosure agreement checkbox in an assignment\n * configured with SafeAssign.\n */\ndefine(['jquery', 'core/str'], function($, str) {\n\n    return {\n\n        /**\n         * Adds a new DOM element in the submission tree object to display the average plagiarism\n         * score for some submission.\n         * @param {int} avgScore\n         * @param {int} userId\n         * @param {string} originalityReportLink\n         */\n        init: function(avgScore, userId, originalityReportLink) {\n\n            /**\n             * Checks if some element exist in page DOM.\n             * @param {string} selector\n             * @returns {boolean}\n             */\n            var elementExists = function(selector) {\n                var el = $(selector);\n                return (el.length) ? true : false;\n            };\n\n            /**\n             * Creates a new DOM element and attach it into the file submission tree.\n             * @param {string} selector\n             */\n            var appendAvgScoreFilesTree = function(selector) {\n                if (!elementExists('#safeassign_score_' + userId)) {\n                    var tree = $(selector);\n                    var td = $('<td></td>').attr('id', 'safeassign_text_' + userId);\n                    td.addClass('ygtvcell ygtvhtml ygtvcontent');\n                    var trow = $('<tr></tr>').addClass('ygtvrow').append(td);\n                    var table = $('<table></table>').attr('id', 'safeassign_score_' + userId).append(trow);\n                    var div = $('<div></div>').addClass('ygtvitem').append(table);\n                    tree.prepend(div);\n                    if (originalityReportLink) {\n                        var reporttd = $('<td></td>').attr('id', 'safeassign_or_' + userId)\n                            .addClass('ygtvcell ygtvhtml ygtvcontent');\n                        reporttd.append(originalityReportLink);\n                        var reportrow = $('<tr></tr>').addClass('ygtvrow').append(reporttd);\n                        $('#safeassign_score_' + userId).append(reportrow);\n                    }\n                    getMessage(avgScore, '#safeassign_text_' + userId);\n                }\n            };\n\n            /**\n             * Creates a new DOM element and attach it into the online submission region.\n             * @param {string} selector\n             */\n            var appendAvgScoreOnlineSubm = function(selector) {\n                if (!elementExists('#safeassign_online_sub_' + userId)) {\n                    var el = $(selector).parent();\n                    var div = $('<div></div>').attr('id', 'safeassign_online_sub_' + userId);\n                    if (originalityReportLink) {\n                        var reportdiv = $('<div></div>').attr('id', 'safeassign_online_or_' + userId);\n                        reportdiv.append(originalityReportLink);\n                        el.prepend(reportdiv);\n                    }\n                    el.prepend(div);\n                    getMessage(avgScore, '#safeassign_online_sub_' + userId);\n                }\n            };\n\n            /**\n             * Returns a message with the average score.\n             * @param {int} avgScore\n             * @param {string} selector\n             */\n            var getMessage = function(avgScore, selector) {\n\n                // Get overall score string via ajax.\n                var messageString = str.get_string('safeassign_overall_score', 'plagiarism_safeassign', avgScore);\n\n                $.when(messageString).done(function(s) {\n                    $(selector).append(s);\n                });\n\n            };\n\n            /**\n             * Makes a JQuery promise to see if some element exist in the DOM.\n             * @param {string} containerSelector\n             * @param {int} maxIterations\n             * @returns {promise} JQuery promise\n             */\n            var whenTrue = function(containerSelector, maxIterations) {\n                maxIterations = !maxIterations ? 10 : maxIterations;\n\n                var prom = $.Deferred();\n                var i = 0;\n                var checker = setInterval(function() {\n                    i = i + 1;\n                    if (i > maxIterations) {\n                        prom.reject();\n                        clearInterval(checker);\n                    } else {\n                        if (elementExists(containerSelector)) {\n                            prom.resolve();\n                            clearInterval(checker);\n                        }\n                    }\n                }, 200);\n\n                return prom.promise();\n            };\n\n            // Checks if we are on assign grading view.\n            var pageObject = $('#page-mod-assign-grading');\n            var isFeedbackView = pageObject.length;\n            var fileSelector = '.ygtvchildren';\n            var onlineSelector = '.plagiarism-inline.online-text-div';\n            if (isFeedbackView) {\n                fileSelector = '.user' + userId + ' .ygtvchildren';\n                onlineSelector = '.user' + userId + ' td div.plagiarism-inline.online-text-div';\n            }\n\n            var readyFiles = whenTrue(fileSelector, 20);\n            readyFiles.then(function() {\n                appendAvgScoreFilesTree(fileSelector);\n            });\n\n            var readyOnline = whenTrue(onlineSelector, 20);\n            readyOnline.then(function() {\n                appendAvgScoreOnlineSubm(onlineSelector);\n            });\n\n        }\n    };\n});\n"],"names":["define","$","str","init","avgScore","userId","originalityReportLink","elementExists","selector","length","getMessage","messageString","get_string","when","done","s","append","whenTrue","containerSelector","maxIterations","prom","Deferred","i","checker","setInterval","reject","clearInterval","resolve","promise","isFeedbackView","fileSelector","onlineSelector","then","tree","td","attr","addClass","trow","table","div","prepend","reporttd","reportrow","appendAvgScoreFilesTree","el","parent","reportdiv","appendAvgScoreOnlineSubm"],"mappings":";;;;;;;;;;;;;;;;;;;;AAyBAA,qCAAO,CAAC,SAAU,aAAa,SAASC,EAAGC,WAEhC,CASHC,KAAM,SAASC,SAAUC,OAAQC,2BAOzBC,cAAgB,SAASC,kBAChBP,EAAEO,UACAC,QAkDXC,WAAa,SAASN,SAAUI,cAG5BG,cAAgBT,IAAIU,WAAW,2BAA4B,wBAAyBR,UAExFH,EAAEY,KAAKF,eAAeG,MAAK,SAASC,GAChCd,EAAEO,UAAUQ,OAAOD,OAWvBE,SAAW,SAASC,kBAAmBC,eACvCA,cAAiBA,eAAgB,OAE7BC,KAAOnB,EAAEoB,WACTC,EAAI,EACJC,QAAUC,aAAY,YACtBF,GAAQ,GACAH,eACJC,KAAKK,SACLC,cAAcH,UAEVhB,cAAcW,qBACdE,KAAKO,UACLD,cAAcH,YAGvB,YAEIH,KAAKQ,WAKZC,eADa5B,EAAE,4BACaQ,OAC5BqB,aAAe,gBACfC,eAAiB,qCACjBF,iBACAC,aAAe,QAAUzB,OAAS,iBAClC0B,eAAiB,QAAU1B,OAAS,6CAGvBY,SAASa,aAAc,IAC7BE,MAAK,YA5Fc,SAASxB,cAC9BD,cAAc,qBAAuBF,QAAS,KAC3C4B,KAAOhC,EAAEO,UACT0B,GAAKjC,EAAE,aAAakC,KAAK,KAAM,mBAAqB9B,QACxD6B,GAAGE,SAAS,qCACRC,KAAOpC,EAAE,aAAamC,SAAS,WAAWpB,OAAOkB,IACjDI,MAAQrC,EAAE,mBAAmBkC,KAAK,KAAM,oBAAsB9B,QAAQW,OAAOqB,MAC7EE,IAAMtC,EAAE,eAAemC,SAAS,YAAYpB,OAAOsB,UACvDL,KAAKO,QAAQD,KACTjC,sBAAuB,KACnBmC,SAAWxC,EAAE,aAAakC,KAAK,KAAM,iBAAmB9B,QACvD+B,SAAS,iCACdK,SAASzB,OAAOV,2BACZoC,UAAYzC,EAAE,aAAamC,SAAS,WAAWpB,OAAOyB,UAC1DxC,EAAE,qBAAuBI,QAAQW,OAAO0B,WAE5ChC,WAAWN,SAAU,oBAAsBC,SA6E/CsC,CAAwBb,iBAGVb,SAASc,eAAgB,IAC/BC,MAAK,YAzEc,SAASxB,cAC/BD,cAAc,0BAA4BF,QAAS,KAChDuC,GAAK3C,EAAEO,UAAUqC,SACjBN,IAAMtC,EAAE,eAAekC,KAAK,KAAM,yBAA2B9B,WAC7DC,sBAAuB,KACnBwC,UAAY7C,EAAE,eAAekC,KAAK,KAAM,wBAA0B9B,QACtEyC,UAAU9B,OAAOV,uBACjBsC,GAAGJ,QAAQM,WAEfF,GAAGJ,QAAQD,KACX7B,WAAWN,SAAU,0BAA4BC,SAgErD0C,CAAyBhB"}